<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Localstore</title>

  <link href="https://fonts.googleapis.com/css?family=Poppins" rel="stylesheet" />
  <link href="css/main.css" rel="stylesheet" />

  <style>
    body { font-family: Poppins, Arial, sans-serif; padding: 24px; background:#f7f7f8; }
    .s01 { max-width: 780px; margin: 0 auto; }
    .inner-form { display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; }
    .input-field { position: relative; }
    input { padding:10px 12px; border:1px solid #ddd; border-radius:6px; width:320px; box-sizing:border-box; }

    /* Caja de resultados */
    #results {
      max-width: 780px;
      margin: 20px auto;
    }
    #results p { background:#fff; padding:12px; margin-bottom:8px; border-radius:6px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
    #results a { font-weight:600; color:#0070f3; text-decoration:none; }
    #results span { color:#555; font-size:14px; }

    /* AUTOCOMPLETADO (compartido) */
    .autocomplete-box {
      background: white;
      border: 1px solid #ccc;
      border-radius: 5px;
      width: 100%;
      max-width: 320px;
      position: absolute;
      top: 44px;
      left: 0;
      z-index: 9999;
      font-family: Poppins, Arial, sans-serif;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
      overflow: hidden;
    }
    .autocomplete-box .item {
      padding: 8px 12px;
      cursor: pointer;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }
    .autocomplete-box .item:hover { background: #f0f0f0; }
    .btn-search { padding:10px 16px; border-radius:6px; background:#0070f3; color:#fff; border:0; cursor:pointer; }
  </style>
</head>

<body>

  <div class="s01">
    <h2>Encuentra tu tienda local</h2>

    <div class="inner-form">

      <!-- Campo de categoría con autocompletado -->
      <div class="input-field" style="position: relative;">
        <input id="search" type="text" placeholder="¿Qué estás buscando?" autocomplete="off" />
        <div id="autocomplete-categories" class="autocomplete-box" style="display:none;"></div>
      </div>

      <!-- Campo de ubicación con autocompletado -->
      <div class="input-field" style="position: relative;">
        <input id="location" type="text" placeholder="¿Dónde lo estás buscando?" autocomplete="off" />
        <div id="autocomplete-places" class="autocomplete-box" style="display:none;"></div>
      </div>

      <div class="input-field">
        <button class="btn-search" type="button" id="btnSearch">Buscar</button>
      </div>
    </div>
  </div>

  <div id="results"></div>

  <script>
    // elementos
    const searchInput = document.getElementById('search');
    const locationInput = document.getElementById('location');
    const btnSearch = document.getElementById('btnSearch');
    const resultsDiv = document.getElementById('results');
    const acCats = document.getElementById('autocomplete-categories');
    const acPlaces = document.getElementById('autocomplete-places');

    // helper debounce
    function debounce(fn, wait = 180) {
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...args), wait);
      };
    }

    // helper fetch + tolerate response shape
    async function fetchJson(url) {
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const json = await res.json();
      return json;
    }

    /* ---------- AUTOCOMPLETE CATEGORIES ---------- */
    async function loadCategorySuggestions(q) {
      if (!q) { acCats.style.display = 'none'; acCats.innerHTML=''; return; }
      try {
        const json = await fetchJson(`/api/categories?q=${encodeURIComponent(q)}`);
        const items = Array.isArray(json) ? json : (json.categories || json.data || []);
        if (!items || items.length === 0) { acCats.style.display = 'none'; acCats.innerHTML=''; return; }

        acCats.innerHTML = items.map(c => `<div class="item" data-id="${c.id}" data-name="${c.category}">${c.category}</div>`).join('');
        acCats.style.display = 'block';

        // handlers
        acCats.querySelectorAll('.item').forEach(el => {
          el.addEventListener('click', () => {
            searchInput.value = el.dataset.name;
            searchInput.dataset.categoryId = el.dataset.id;
            acCats.style.display = 'none';
          });
        });
      } catch (err) {
        console.error('autocomplete categories error', err);
        acCats.style.display = 'none';
      }
    }
    searchInput.addEventListener('input', debounce((e) => loadCategorySuggestions(e.target.value.trim())));

    /* ---------- AUTOCOMPLETE PLACES ---------- */
    async function loadPlaceSuggestions(q) {
      if (!q) { acPlaces.style.display = 'none'; acPlaces.innerHTML=''; return; }
      try {
        const json = await fetchJson(`/api/places?q=${encodeURIComponent(q)}`);
        const items = Array.isArray(json) ? json : (json.places || json.data || []);
        if (!items || items.length === 0) { acPlaces.style.display = 'none'; acPlaces.innerHTML=''; return; }

        acPlaces.innerHTML = items.map(p => `<div class="item" data-id="${p.id}" data-name="${p.placename || p.name || ''}">${p.placename || p.name || ''}</div>`).join('');
        acPlaces.style.display = 'block';

        acPlaces.querySelectorAll('.item').forEach(el => {
          el.addEventListener('click', () => {
            locationInput.value = el.dataset.name;
            locationInput.dataset.placeId = el.dataset.id;
            acPlaces.style.display = 'none';
          });
        });
      } catch (err) {
        console.error('autocomplete places error', err);
        acPlaces.style.display = 'none';
      }
    }
    locationInput.addEventListener('input', debounce((e) => loadPlaceSuggestions(e.target.value.trim())));

    // click fuera cierra ambos
    document.addEventListener('click', (ev) => {
      if (!acCats.contains(ev.target) && ev.target !== searchInput) { acCats.style.display = 'none'; }
      if (!acPlaces.contains(ev.target) && ev.target !== locationInput) { acPlaces.style.display = 'none'; }
    });

    /* ---------- BÚSQUEDA ---------- */
    async function doSearch() {
      const categoryId = searchInput.dataset.categoryId || '';
      const placeId = locationInput.dataset.placeId || '';

      const params = new URLSearchParams();

      // si tenemos ids, los preferimos (búsqueda exacta)
      if (categoryId) params.append('category_id', categoryId);
      else if (searchInput.value.trim()) params.append('category', searchInput.value.trim());

      if (placeId) params.append('place_id', placeId);
      else if (locationInput.value.trim()) params.append('place', locationInput.value.trim());

      if (!categoryId && !placeId && !searchInput.value.trim() && !locationInput.value.trim()) {
        resultsDiv.innerHTML = '<p>Introduce al menos una categoría o ubicación.</p>';
        return;
      }

      resultsDiv.innerHTML = '<p>Cargando resultados...</p>';

      try {
        const res = await fetch('/api/shops?' + params.toString(), { cache: 'no-store' });
        if (!res.ok) throw new Error('Error en la petición');
        const json = await res.json();

        // aceptar varios formatos robustamente
        const rows = json.data || json.shops || json.results || json.data || json || [];
        const items = Array.isArray(rows) ? rows : (rows.data || []);

        if (!items || items.length === 0) {
          resultsDiv.innerHTML = '<p>No se encontraron resultados.</p>';
          return;
        }

        resultsDiv.innerHTML = items.map(s => {
          const catName = s.category_name || s.category_label || s.category || '';
          const placeName = s.place_name || s.place || s.placename || '';
          return `
            <p>
              <a href="/shop.html?id=${s.id}">${s.name}</a><br>
              <span>${catName ? (catName + ' • ') : ''}${placeName}</span>
            </p>
          `;
        }).join('');
      } catch (err) {
        console.error('Error fetching shops', err);
        resultsDiv.innerHTML = '<p>Error al buscar tiendas.</p>';
      }
    }

    btnSearch.addEventListener('click', doSearch);

    // opción: hacer búsqueda con Enter en cualquiera de los inputs
    [searchInput, locationInput].forEach(inp => {
      inp.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          doSearch();
        }
      });
    });
  </script>

</body>
</html>
