<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Anúnciate</title>
    <link href="https://fonts.googleapis.com/css?family=Poppins" rel="stylesheet">
    <style>
        :root{
            --accent:#365cab;
            --muted:#6b7280;
            --card-bg:#fff;
            --radius:10px;
        }
        body{
            font-family:Poppins, Arial, sans-serif;
            max-width:760px;
            margin:120px auto 60px;
            padding:20px;
            color:#222;
        }
        h1{font-size:28px;margin-bottom:10px}
        p{color:#555;line-height:1.6}
        
        /* ---------- OPTIONS ---------- */
        .options{
            display:flex;
            gap:30px;
            margin-top:40px;
        }
        .option{
            flex:1;
            background:#f8fafc;
            border-radius:12px;
            padding:30px;
            text-align:center;
            cursor:pointer;
            box-shadow:0 8px 24px rgba(0,0,0,.05);
            opacity:0;
        }
        .option.left{animation:slideLeft .6s forwards}
        .option.right{animation:slideRight .6s forwards}
        @keyframes slideLeft{
            from{transform:translateX(-40px);opacity:0}
            to{transform:none;opacity:1}
        }
        @keyframes slideRight{
            from{transform:translateX(40px);opacity:0}
            to{transform:none;opacity:1}
        }
        .option h2{margin-bottom:10px}
        
        /* ---------- DISCLAIMER ---------- */
        #disclaimer{
            display:none;
            margin-top:40px;
            background:#f8fafc;
            padding:30px;
            border-radius:12px;
        }
        #disclaimer label{display:flex;gap:10px;align-items:flex-start}
        
        /* ---------- FORM ---------- */
        #formWrapper{display:none;margin-top:40px}
        table{
            width:100%;
            background:var(--card-bg);
            border-radius:14px;
            box-shadow:0 10px 30px rgba(0,0,0,.06);
        }
        td{padding:22px;vertical-align:top}
        .field{margin-bottom:14px}
        .label{
            font-size:12px;
            color:var(--muted);
            text-transform:uppercase;
            letter-spacing:.5px;
        }
        input, textarea{
            width:100%;
            border:1px solid #ddd;
            border-radius:8px;
            padding:10px;
            font-family:Poppins;
        }
        textarea{resize:vertical}
        button{
            background:var(--accent);
            color:#fff;
            border:none;
            padding:14px 22px;
            border-radius:10px;
            font-weight:600;
            cursor:pointer;
            margin-top:20px;
        }
        
        /* ---------- HORARIOS ---------- */
        .schedule-section {
            margin-top: 30px;
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
        }
        .schedule-section h3 {
            margin-top: 0;
            margin-bottom: 20px;
        }
        .day-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e5e7eb;
        }
        .day-row:last-child {
            border-bottom: none;
        }
        .day-label {
            width: 100px;
            font-weight: 500;
        }
        .time-inputs {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }
        .time-inputs input {
            width: 80px;
            text-align: center;
        }
        .closed-check {
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }
        .closed-check input {
            width: auto;
        }
        
        /* ---------- PREVIEW ---------- */
        #previewWrapper{
            display:none;
            margin-top:40px;
        }
        .preview-image-container {
            width: 100%;
            max-width: 350px;
            margin: 6px 0 0;
        }
        .full-image {
            width: 100%;
            height: 250px;
            border-radius: 10px;
            object-fit: cover;
            display: block;
            box-shadow: 0 8px 20px rgba(15,23,42,0.06);
            border: 1px solid rgba(0,0,0,0.03);
        }
        .schedule-preview {
            margin-top: 20px;
            background: #f8fafc;
            border-radius: 10px;
            padding: 15px;
        }
        .schedule-day {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e7eb;
        }
        .schedule-day:last-child {
            margin-bottom: 0;
            border-bottom: none;
        }
        .day-name {
            font-weight: 500;
            color: #374151;
        }
        .day-schedule {
            color: #6b7280;
        }
        .closed {
            color: #ef4444;
        }
        
        /* ---------- MODAL ---------- */
        #confirmModal{
            display:none;
            position:fixed;
            inset:0;
            background:rgba(0,0,0,.4);
            align-items:center;
            justify-content:center;
        }
        .modal{
            background:#fff;
            padding:30px;
            border-radius:12px;
            max-width:400px;
            text-align:center;
        }
        .modal button{margin:10px}
        #legalBox{
            max-height:220px;
            overflow-y:auto;
            padding:16px;
            border:1px solid #ddd;
            border-radius:8px;
            background:#fff;
            font-size:14px;
            line-height:1.6;
        }
        #acceptBtn:disabled{
            opacity:.4;
            cursor:not-allowed;
        }
    </style>
</head>
<body>
    <h1>Anúnciate</h1>
    <p>Aquí podrás anunciar tu negocio gratuitamente. Revisaremos la información antes de publicarla.</p>
    
    <div class="options" id="options">
        <div class="option left" id="addBtn">
            <h2>Anunciar mi negocio</h2>
            <p>Publica tu ficha gratuitamente</p>
        </div>
        <div class="option right">
            <h2>Modificar mi anuncio</h2>
            <p>Próximamente</p>
        </div>
    </div>
    
    <!-- DISCLAIMER -->
    <div id="disclaimer">
        <div id="legalBox">
            <h3>Información sobre protección de datos y consentimiento</h3>
            <p>
                De conformidad con lo establecido en el Reglamento (UE) 2016/679 (Reglamento General de Protección de Datos) y la normativa vigente en materia de protección de datos, le informamos de que los datos personales que facilite a través de este formulario serán tratados por LocalStore, como responsable del tratamiento, con la finalidad de atender su solicitud, gestionar la relación comercial y enviarle comunicaciones informativas y promocionales relacionadas con nuestros productos, servicios, actividades o iniciativas vinculadas al negocio.
            </p>
            <p>
                El tratamiento de sus datos se basa en el consentimiento expreso otorgado mediante la aceptación de la presente cláusula, consentimiento que podrá retirar en cualquier momento sin que ello afecte a la licitud del tratamiento previo a su retirada.
            </p>
            <p>
                Sus datos no serán cedidos a terceros, salvo en los casos en que exista una obligación legal, y se conservarán durante el tiempo estrictamente necesario para cumplir con la finalidad para la que fueron recabados o mientras exista un interés legítimo o consentimiento válido.
            </p>
            <p>
                Asimismo, le informamos de que puede ejercer en cualquier momento sus derechos de acceso, rectificación, supresión, limitación del tratamiento, oposición y portabilidad de sus datos, enviando una solicitud junto con una copia de un documento identificativo a localstore@mail.com.
            </p>
            <p>
                Al enviar este formulario, usted declara haber leído y comprendido la presente información y acepta expresamente el tratamiento de sus datos personales en los términos indicados.
            </p>
        </div>
        <label style="margin-top:14px;display:flex;gap:10px;">
            <input type="checkbox" id="acceptCheck">
            <span>Acepto el tratamiento de mis datos</span>
        </label>
        <button id="acceptBtn" disabled>Continuar</button>
    </div>
    
    <!-- FORM -->
    <div id="formWrapper">
        <form id="shopForm">
            <table>
                <tr>
                    <td>
                        <div class="field">
                            <div class="label">Nombre</div>
                            <input name="name" required>
                        </div>
                        <div class="field">
                            <div class="label">Imagen del negocio</div>
                            <input type="file" name="image" id="imageInput" accept="image/*">
                        </div>
                        <div class="field">
                            <div class="label">Categoría</div>
                            <input name="category">
                        </div>
                        <div class="field">
                            <div class="label">Dirección</div>
                            <input name="address">
                        </div>
                        <div class="field">
                            <div class="label">Teléfono</div>
                            <input name="phone">
                        </div>
                        <div class="field">
                            <div class="label">Email</div>
                            <input name="email">
                        </div>
                        <div class="field">
                            <div class="label">Web</div>
                            <input name="website">
                        </div>
                        <div class="field">
                            <div class="label">Descripción</div>
                            <textarea name="description"></textarea>
                        </div>
                    </td>
                </tr>
            </table>
            
            <!-- HORARIOS -->
            <div class="schedule-section">
                <h3>Horario de atención</h3>
                <div id="scheduleFields">
                    <!-- Los días se generarán con JavaScript -->
                </div>
            </div>
            
            <button type="button" id="previewBtn">Previsualizar</button>
        </form>
    </div>
    
    <!-- PREVIEW -->
    <div id="previewWrapper" style="display:none;margin-top:40px;">
        <h1 id="previewName"></h1>
        <table id="shopLayout">
            <tr>
                <td id="leftCol">
                    <div id="previewData"></div>
                </td>
                <td id="rightCol">
                    <div id="previewImage"></div>
                    <div id="previewSchedule" class="schedule-preview"></div>
                </td>
            </tr>
        </table>
        <div style="margin-top:24px;display:flex;gap:14px;">
            <button id="editBtn">Modificar</button>
            <button id="finalSubmitBtn">Enviar solicitud</button>
        </div>
    </div>
    
    <!-- CONFIRM MODAL -->
    <div id="confirmModal">
        <div class="modal">
            <p>¿Estás seguro de enviar este anuncio?</p>
            <button id="confirmYes">Sí, enviar</button>
            <button onclick="closeModal()">Cancelar</button>
        </div>
    </div>

    <script>
        // Disclaimer logic
        const legalBox = document.getElementById("legalBox");
        const acceptCheck = document.getElementById("acceptCheck");
        const acceptBtn = document.getElementById("acceptBtn");
        let scrolledToBottom = false;

        function updateButtonState(){
            acceptBtn.disabled = !(scrolledToBottom && acceptCheck.checked);
        }

        legalBox.addEventListener("scroll", () => {
            const tolerance = 5;
            if (legalBox.scrollTop + legalBox.clientHeight >= legalBox.scrollHeight - tolerance) {
                scrolledToBottom = true;
                updateButtonState();
            }
        });

        acceptCheck.addEventListener("change", updateButtonState);

        acceptBtn.onclick = () => {
            document.getElementById("disclaimer").style.display = "none";
            document.getElementById("formWrapper").style.display = "block";
            generateScheduleFields();
        };

        // Show disclaimer
        const addBtn = document.getElementById("addBtn");
        const options = document.getElementById("options");
        const disclaimer = document.getElementById("disclaimer");

        addBtn.addEventListener("click", () => {
            options.style.display = "none";
            disclaimer.style.display = "block";
        });

        // Generate schedule fields
        function generateScheduleFields() {
            const scheduleFields = document.getElementById("scheduleFields");
            const days = [
                { id: 'monday', name: 'Lunes' },
                { id: 'tuesday', name: 'Martes' },
                { id: 'wednesday', name: 'Miércoles' },
                { id: 'thursday', name: 'Jueves' },
                { id: 'friday', name: 'Viernes' },
                { id: 'saturday', name: 'Sábado' },
                { id: 'sunday', name: 'Domingo' }
            ];

            scheduleFields.innerHTML = '';

            days.forEach(day => {
                const dayRow = document.createElement('div');
                dayRow.className = 'day-row';
                dayRow.innerHTML = `
                    <div class="day-label">${day.name}</div>
                    <div class="time-inputs">
                        <input type="time" id="${day.id}_open" name="${day.id}_open" placeholder="Apertura">
                        <span>a</span>
                        <input type="time" id="${day.id}_close" name="${day.id}_close" placeholder="Cierre">
                    </div>
                    <div class="closed-check">
                        <input type="checkbox" id="${day.id}_closed" name="${day.id}_closed">
                        <label for="${day.id}_closed">Cerrado</label>
                    </div>
                `;
                scheduleFields.appendChild(dayRow);

                // Add event listeners for closed checkbox
                const closedCheck = document.getElementById(`${day.id}_closed`);
                const openInput = document.getElementById(`${day.id}_open`);
                const closeInput = document.getElementById(`${day.id}_close`);

                closedCheck.addEventListener('change', function() {
                    if (this.checked) {
                        openInput.disabled = true;
                        closeInput.disabled = true;
                        openInput.value = '';
                        closeInput.value = '';
                    } else {
                        openInput.disabled = false;
                        closeInput.disabled = false;
                    }
                });
            });
        }

        // Preview logic
        const previewBtn = document.getElementById("previewBtn");
        const formWrapper = document.getElementById("formWrapper");
        const previewWrapper = document.getElementById("previewWrapper");
        const imageInput = document.getElementById("imageInput");

        previewBtn.addEventListener("click", () => {
            const form = document.getElementById("shopForm");
            const data = new FormData(form);

            // Nombre
            document.getElementById("previewName").textContent = data.get("name") || "Sin nombre";

            // Campos
            document.getElementById("previewData").innerHTML = 
                `${renderPreviewField("Categoría", data.get("category"))}
                 ${renderPreviewField("Ubicación", data.get("address"))}
                 ${renderPreviewField("Teléfono", data.get("phone"))}
                 ${renderPreviewLink("Email", data.get("email"), "mailto:" + data.get("email"))}
                 ${renderPreviewLink("Web", data.get("website"), data.get("website"))}
                 ${renderPreviewField("Descripción", data.get("description"))}`;

            // Imagen con tamaño fijo
            const file = imageInput.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                document.getElementById("previewImage").innerHTML = 
                    `<div class="preview-image-container">
                        <img src="${url}" class="full-image">
                    </div>`;
            } else {
                document.getElementById("previewImage").innerHTML = 
                    `<div class="preview-image-container">
                        <div style="color:#999; text-align:center; padding: 20px;">Sin imagen</div>
                    </div>`;
            }

            // Horarios en previsualización
            const scheduleData = getScheduleData();
            document.getElementById("previewSchedule").innerHTML = 
                `<h3 style="margin-top: 0; margin-bottom: 15px;">Horario</h3>
                 ${renderSchedulePreview(scheduleData)}`;

            formWrapper.style.display = "none";
            previewWrapper.style.display = "block";
        });

        // Get schedule data from form
        function getScheduleData() {
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            const schedule = {};
            const form = document.getElementById('shopForm');
            
            days.forEach(day => {
                const closedCheck = document.getElementById(`${day}_closed`);
                if (closedCheck && closedCheck.checked) {
                    schedule[day] = [];
                } else {
                    const open = document.getElementById(`${day}_open`).value;
                    const close = document.getElementById(`${day}_close`).value;
                    if (open && close) {
                        schedule[day] = [{ open, close }];
                    } else {
                        schedule[day] = [];
                    }
                }
            });
            
            return schedule;
        }

        // Render schedule preview
        function renderSchedulePreview(schedule) {
            const dayNames = {
                monday: 'Lunes',
                tuesday: 'Martes',
                wednesday: 'Miércoles',
                thursday: 'Jueves',
                friday: 'Viernes',
                saturday: 'Sábado',
                sunday: 'Domingo'
            };

            let html = '';
            
            Object.entries(schedule).forEach(([day, times]) => {
                let scheduleText = '';
                
                if (times.length === 0) {
                    scheduleText = '<span class="closed">Cerrado</span>';
                } else {
                    scheduleText = times.map(time => 
                        `${time.open} - ${time.close}`
                    ).join(', ');
                }
                
                html += `
                    <div class="schedule-day">
                        <div class="day-name">${dayNames[day]}</div>
                        <div class="day-schedule">${scheduleText}</div>
                    </div>
                `;
            });
            
            return html;
        }

        // Botón Modificar
        document.getElementById("editBtn").addEventListener("click", () => {
            previewWrapper.style.display = "none";
            formWrapper.style.display = "block";
        });

        // ============================================================
        // BOTÓN "ENVIAR SOLICITUD" CON WEB3FORMS - CÓDIGO CORREGIDO
        // ============================================================
        document.getElementById("finalSubmitBtn").addEventListener("click", async () => {
            const submitBtn = document.getElementById("finalSubmitBtn");
            const originalText = submitBtn.textContent;
            
            // Deshabilitar el botón para evitar múltiples envíos
            submitBtn.disabled = true;
            submitBtn.textContent = "Enviando...";
            
            try {
                // 1. RECOLECTAR DATOS DEL FORMULARIO Y HORARIOS
                const form = document.getElementById("shopForm");
                const formData = new FormData(form);
                const scheduleData = getScheduleData(); // Usamos la función existente
                
                // Convertir todo a un objeto plano para Web3Forms
                const dataObject = {
                    access_key: "e914a7b1-7805-4c73-bb65-d2cc8cd6a5d5", // Tu nueva clave
                    subject: `Nueva Solicitud de Anuncio: ${formData.get("name") || "Sin nombre"}`,
                    from_name: "Formulario LocalStore",
                    
                    // Mapear campos del formulario
                    "Nombre del Negocio": formData.get("name"),
                    "Categoría": formData.get("category"),
                    "Dirección": formData.get("address"),
                    "Teléfono": formData.get("phone"),
                    "Email": formData.get("email"),
                    "Sitio Web": formData.get("website"),
                    "Descripción": formData.get("description"),
                    
                    // Convertir horarios a texto legible para el correo
                    "Horarios (JSON)": JSON.stringify(scheduleData, null, 2),
                    "Horarios (Texto)": formatScheduleForEmail(scheduleData),
                    
                    // Campo anti-spam (debe estar presente)
                    botcheck: ""
                };
                
                // 2. MANEJAR LA IMAGEN (si se subió una)
                const imageFile = document.getElementById("imageInput").files[0];
                const finalFormData = new FormData();
                
                // Agregar todos los campos del objeto al FormData
                for (const key in dataObject) {
                    finalFormData.append(key, dataObject[key]);
                }
                
                // Agregar la imagen SI EXISTE
                if (imageFile) {
                    // Validar tamaño (~5MB límite en plan gratuito)
                    const fileSizeMB = imageFile.size / (1024 * 1024);
                    if (fileSizeMB > 5) {
                        alert(`La imagen (${fileSizeMB.toFixed(1)}MB) supera el límite recomendado de 5MB. Por favor, comprímela.`);
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                        return;
                    }
                    finalFormData.append("attachment", imageFile);
                }
                
                // 3. ENVIAR A WEB3FORMS
                const response = await fetch("https://api.web3forms.com/submit", {
                    method: "POST",
                    body: finalFormData
                    // NO agregar headers 'Content-Type' cuando se envía FormData con archivos
                });
                
                const result = await response.json();
                
                // 4. MANEJAR RESPUESTA
                if (response.status === 200) {
                    alert("✅ ¡Solicitud enviada con éxito! Revisa el correo localstore@mail.com.");
                    
                    // Aquí puedes agregar una redirección si lo deseas:
                    // window.location.href = "gracias.html";
                    
                    // Opcional: Limpiar el formulario después del envío
                    // form.reset();
                    // previewWrapper.style.display = "none";
                    // formWrapper.style.display = "block";
                    
                } else {
                    alert(`❌ Error al enviar: ${result.message || "Por favor, intenta de nuevo."}`);
                }
                
            } catch (error) {
                console.error("Error de conexión:", error);
                alert("⚠️ No se pudo conectar. Verifica tu internet e intenta nuevamente.");
            } finally {
                // 5. RESTAURAR BOTÓN
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });

        // FUNCIÓN ADICIONAL: Formatear horarios para el cuerpo del correo
        function formatScheduleForEmail(schedule) {
            const dayNames = {
                monday: "Lunes",
                tuesday: "Martes",
                wednesday: "Miércoles",
                thursday: "Jueves",
                friday: "Viernes",
                saturday: "Sábado",
                sunday: "Domingo"
            };
            
            let text = "";
            for (const [day, times] of Object.entries(schedule)) {
                text += `${dayNames[day]}: `;
                if (times.length === 0) {
                    text += "Cerrado\n";
                } else {
                    text += times.map(t => `${t.open} - ${t.close}`).join(" / ") + "\n";
                }
            }
            return text;
        }

        // Helper functions para previsualización
        function renderPreviewField(label, value){
            if (!value) return "";
            return `<div class="field">
                <div class="label">${label}</div>
                <div class="value">${value}</div>
            </div>`;
        }

        function renderPreviewLink(label, value, href){
            if (!value) return "";
            const safe = href.startsWith("http") || href.startsWith("mailto:") ? href : "https://" + href;
            return `<div class="field">
                <div class="label">${label}</div>
                <a class="value" href="${safe}" target="_blank">${value}</a>
            </div>`;
        }

        // Modal functions
        function closeModal() {
            document.getElementById("confirmModal").style.display = "none";
        }
    </script>
</body>
</html>
